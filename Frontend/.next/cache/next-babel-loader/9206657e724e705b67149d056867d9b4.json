{"ast":null,"code":"import React, { useCallback, useState, useEffect } from \"react\";\nimport styled from \"styled-components\";\nimport { Avatar, Popover, Comment, Input, Image, Checkbox } from \"antd\";\nimport ProfileModal from \"../../modal/ProfileModal\";\nimport { UserOutlined, LockOutlined, LikeOutlined, LikeFilled } from \"@ant-design/icons\";\nimport { useSelector, useDispatch } from \"react-redux\";\nimport useToggle from \"../../../hooks/useToggle\";\nimport { SERVER_URL } from \"../../../lib/constant/constant\";\nimport { addCommentRequestAction, deleteCommentRequestAction, likeCommentRequestAction, unLikeCommentRequestAction } from \"../../../reducers/post\";\nimport useInput from \"../../../hooks/useInput\";\nimport Router from \"next/router\";\nimport axios from \"axios\";\nimport ReCommentListItem from \"./ReCommentListItem\";\n/**\n * @author 박진호\n * @version 1.0\n * @summary 댓글 리스트 아이템 컴포넌트\n */\n// style\n\nimport { jsx as _jsx } from \"react/jsx-runtime\";\nimport { jsxs as _jsxs } from \"react/jsx-runtime\";\nimport { Fragment as _Fragment } from \"react/jsx-runtime\";\nconst ReApplyFormWrapper = styled.div.withConfig({\n  displayName: \"CommentListItem__ReApplyFormWrapper\",\n  componentId: \"ugl3jc-0\"\n})([\"width:800px;display:flex;@media (max-width:768px){width:200px;display:block;}\"]);\nconst ReApplyInput = styled(Input.TextArea).withConfig({\n  displayName: \"CommentListItem__ReApplyInput\",\n  componentId: \"ugl3jc-1\"\n})([\"flex:7;\"]);\nconst ButtonWrapper = styled.div.withConfig({\n  displayName: \"CommentListItem__ButtonWrapper\",\n  componentId: \"ugl3jc-2\"\n})([\"line-height:30px;flex:1;.cancel-btn{cursor:pointer;margin-left:5px;}.submit-btn{cursor:pointer;color:#208fff;margin-left:10px;}.secret-btn{margin-left:10px;}\"]);\nconst CommentActivityWrapper = styled.div.withConfig({\n  displayName: \"CommentListItem__CommentActivityWrapper\",\n  componentId: \"ugl3jc-3\"\n})([\"font-size:11px;padding:0 3px;cursor:pointer;\"]);\n\nconst CommentListItem = ({\n  item,\n  post\n}) => {\n  // redux\n  const {\n    me\n  } = useSelector(state => state.user);\n  const dispatch = useDispatch(); // local state\n\n  const [reComment, onChangeReComment] = useInput(\"\");\n  const {\n    0: editCommentText,\n    1: setEditCommentText\n  } = useState(\"\");\n  const [isSecret, onToggleIsSecret] = useToggle(false);\n  const [isEdit, onToggleIsEdit] = useToggle(false);\n  const {\n    0: isEditSecret,\n    1: setIsEditSecret\n  } = useState(false);\n  const [applyToggle, onChangeApplyToggle] = useToggle(false);\n  const {\n    0: like,\n    1: setLike\n  } = useState(item.likes.some((v, i) => {\n    if (me && v.userId === me._id) {\n      return true;\n    }\n  }) ? true : false); // event listener\n\n  const onChangeEditCommentText = useCallback(e => {\n    setEditCommentText(e.target.value);\n  }, []);\n  const onToggleIsEditSecret = useCallback(() => {\n    setIsEditSecret(!isEditSecret);\n  }, [isEditSecret]);\n  const onToggleLike = useCallback(() => {\n    setLike(!like);\n\n    if (like) {\n      dispatch(unLikeCommentRequestAction({\n        user: me,\n        id: item.likes.find((v, i) => {\n          if (v.userId === me._id) {\n            return true;\n          }\n        })._id,\n        type: \"comment\",\n        commentId: item._id\n      }));\n    } else {\n      dispatch(likeCommentRequestAction({\n        user: me,\n        id: item._id,\n        type: \"comment\"\n      }));\n    }\n  }, [like, me, item]);\n  const onCancelEdit = useCallback(() => {\n    setEditCommentText(item.content);\n    setIsEditSecret(item.secretComment);\n    onToggleIsEdit();\n  }, [item, isEdit]);\n  const onReCommentSubmit = useCallback(() => {\n    if (reComment === \"\") {\n      alert(\"내용을 입력해주세요.\");\n      return;\n    }\n\n    let submitConfirm = confirm(\"댓글을 등록하시겠습니까?\");\n\n    if (submitConfirm) {\n      dispatch(addCommentRequestAction({\n        postId: post._id,\n        type: post.type,\n        content: reComment,\n        commentTo: item._id,\n        secretComment: isSecret\n      }));\n    } else {\n      return;\n    }\n\n    Router.push(`/articles/${post.type}/${post._id}`);\n  }, [post, item, reComment, isSecret]);\n  const onUpdateComment = useCallback(comment => {\n    if (editCommentText === \"\") {\n      alert(\"내용을 입력해주세요.\");\n      return;\n    }\n\n    let updateConfirm = confirm(\"수정하시겠습니까?\");\n\n    if (updateConfirm) {\n      axios.patch(`/api/comments`, {\n        commentId: comment._id,\n        content: editCommentText,\n        secretComment: isEditSecret\n      }).then(res => {\n        onToggleIsEdit();\n        Router.push(`/articles/${post.type}/${post._id}`);\n      }).catch(error => {\n        alert(\"댓글수정 실패\");\n      });\n    } else {\n      return;\n    }\n  }, [isEditSecret, editCommentText]);\n  const onDeleteComment = useCallback(id => {\n    let confirmDelete = confirm(\"정말로 삭제하시겠습니까?\");\n\n    if (confirmDelete) {\n      let flag = false;\n      let parentId = null;\n      post.comments.forEach((v, i) => {\n        if (id === v.commentTo) {\n          flag = true;\n        }\n      });\n\n      if (flag) {\n        dispatch(deleteCommentRequestAction({\n          type: \"children\",\n          id\n        }));\n      } else {\n        let child;\n        let parent;\n        let childInParentLength = 0;\n        post.comments.forEach((v, i) => {\n          if (id === v._id) {\n            child = v;\n          }\n        });\n        post.comments.forEach((v, i) => {\n          if (child.commentTo === v._id) {\n            parent = v;\n          }\n        });\n        post.comments.forEach((v, i) => {\n          if (parent && parent._id === v.commentTo) {\n            childInParentLength++;\n          }\n        });\n\n        if (parent && parent.isDelete && childInParentLength === 1) {\n          parentId = parent._id;\n          axios.delete(`/api/comments/${parentId}`).then(() => {\n            axios.delete(`/api/comments/${id}`).then(() => {\n              Router.push(`/articles/${post.type}/${post._id}`);\n              return;\n            });\n          });\n        } else {\n          dispatch(deleteCommentRequestAction({\n            type: \"none\",\n            id\n          }));\n        }\n      }\n\n      Router.push(`/articles/${post.type}/${post._id}`);\n    } else {\n      return;\n    }\n  }, [item, post]); // hooks\n\n  useEffect(() => {\n    setEditCommentText(item.content);\n    setIsEditSecret(item.secretComment);\n  }, [item]);\n  return /*#__PURE__*/_jsx(\"li\", {\n    children: /*#__PURE__*/_jsx(Comment, {\n      actions: me && !item.isDelete && (!applyToggle ? isEdit ? [/*#__PURE__*/_jsx(_Fragment, {\n        children: /*#__PURE__*/_jsxs(ReApplyFormWrapper, {\n          children: [/*#__PURE__*/_jsx(ReApplyInput, {\n            rows: 1,\n            onChange: onChangeEditCommentText,\n            defaultValue: item.content\n          }), /*#__PURE__*/_jsxs(ButtonWrapper, {\n            children: [/*#__PURE__*/_jsx(\"span\", {\n              className: \"submit-btn\",\n              onClick: () => {\n                onUpdateComment(item);\n              },\n              children: \"\\uC218\\uC815\"\n            }, \"comment-list-reply-to-0\"), /*#__PURE__*/_jsx(\"span\", {\n              className: \"cancel-btn\",\n              onClick: onCancelEdit,\n              children: \"\\uCDE8\\uC18C\"\n            }, \"comment-list-reply-to-1\"), /*#__PURE__*/_jsx(\"span\", {\n              className: \"secret-btn\",\n              children: /*#__PURE__*/_jsx(Checkbox, {\n                onChange: onToggleIsEditSecret,\n                style: {\n                  color: \"#999\"\n                },\n                defaultChecked: item.secretComment,\n                children: \"\\uBE44\\uBC00 \\uB313\\uAE00\"\n              })\n            }, \"comment-list-reply-to-2\")]\n          })]\n        })\n      })] : [/*#__PURE__*/_jsx(CommentActivityWrapper, {\n        children: me && /*#__PURE__*/_jsxs(\"span\", {\n          style: {\n            marginRight: \"10px\"\n          },\n          onClick: onToggleLike,\n          children: [like ? /*#__PURE__*/_jsx(LikeFilled, {\n            style: {\n              marginRight: \"3px\",\n              color: \"#1a91fe\"\n            }\n          }) : /*#__PURE__*/_jsx(LikeOutlined, {\n            style: {\n              marginRight: \"3px\"\n            }\n          }), item.likes.length]\n        })\n      }), /*#__PURE__*/_jsx(CommentActivityWrapper, {\n        onClick: onChangeApplyToggle,\n        children: \"\\uB300\\uB313\\uAE00 \\uC4F0\\uAE30\"\n      }, \"comment-list-reply-to-0\"), /*#__PURE__*/_jsx(CommentActivityWrapper, {\n        children: item.writer && me._id === item.writer._id && /*#__PURE__*/_jsx(\"span\", {\n          children: \"|\"\n        })\n      }), /*#__PURE__*/_jsx(CommentActivityWrapper, {\n        children: item.writer && me._id === item.writer._id && /*#__PURE__*/_jsx(\"span\", {\n          onClick: () => {\n            onDeleteComment(item._id);\n          },\n          children: \"\\uC0AD\\uC81C\"\n        }, \"comment-list-reply-to-0\")\n      }), /*#__PURE__*/_jsx(CommentActivityWrapper, {\n        children: item.writer && me._id === item.writer._id && /*#__PURE__*/_jsx(\"span\", {\n          children: \"|\"\n        })\n      }), /*#__PURE__*/_jsx(CommentActivityWrapper, {\n        children: item.writer && me._id === item.writer._id && /*#__PURE__*/_jsx(\"span\", {\n          onClick: onToggleIsEdit,\n          children: \"\\uC218\\uC815\"\n        }, \"comment-list-reply-to-0\")\n      }),,] : [/*#__PURE__*/_jsx(_Fragment, {\n        children: /*#__PURE__*/_jsxs(ReApplyFormWrapper, {\n          children: [/*#__PURE__*/_jsx(ReApplyInput, {\n            rows: 1,\n            onChange: onChangeReComment\n          }), /*#__PURE__*/_jsxs(ButtonWrapper, {\n            children: [/*#__PURE__*/_jsx(\"span\", {\n              className: \"submit-btn\",\n              onClick: onReCommentSubmit,\n              children: \"\\uB4F1\\uB85D\"\n            }, \"comment-list-reply-to-0\"), /*#__PURE__*/_jsx(\"span\", {\n              className: \"cancel-btn\",\n              onClick: onChangeApplyToggle,\n              children: \"\\uCDE8\\uC18C\"\n            }, \"comment-list-reply-to-1\"), /*#__PURE__*/_jsx(\"span\", {\n              className: \"secret-btn\",\n              children: /*#__PURE__*/_jsx(Checkbox, {\n                onChange: onToggleIsSecret,\n                style: {\n                  color: \"#999\"\n                },\n                children: \"\\uBE44\\uBC00 \\uB313\\uAE00\"\n              })\n            }, \"comment-list-reply-to-2\")]\n          })]\n        })\n      })]),\n      author: !item.isDelete && item.writer && post.writer && (item.writer._id === post.writer._id ? /*#__PURE__*/_jsx(\"span\", {\n        style: {\n          color: \"#1a91fe\"\n        },\n        children: \"\\uAE00\\uC4F4\\uC774\"\n      }) : item.writer.nickname),\n      avatar: /*#__PURE__*/_jsxs(Popover, {\n        content: /*#__PURE__*/_jsx(\"div\", {\n          onClick: e => {\n            e.stopPropagation();\n          },\n          children: item.writer && !item.isDelete && item.writer.constructor == Object && /*#__PURE__*/_jsx(ProfileModal, {\n            writer: item.writer\n          })\n        }),\n        children: [/*#__PURE__*/_jsx(Avatar, {\n          onClick: e => {\n            e.stopPropagation();\n          },\n          style: {\n            cursor: \"pointer\"\n          },\n          size: 28,\n          icon: /*#__PURE__*/_jsx(UserOutlined, {}),\n          src: !item.isDelete && item.writer && item.writer.avatarUrl && /*#__PURE__*/_jsx(Image, {\n            src: `${SERVER_URL}/${item.writer.avatarUrl}`,\n            width: 28,\n            height: 28\n          })\n        }), \" \"]\n      }),\n      content: item.writer && item.writer.constructor == Object ? item.secretComment ? me && (post.writer && me._id === post.writer._id || item.writer._id === me._id) ? /*#__PURE__*/_jsxs(_Fragment, {\n        children: [/*#__PURE__*/_jsx(\"span\", {\n          children: item.content\n        }), /*#__PURE__*/_jsxs(\"span\", {\n          style: {\n            color: \"#999\",\n            fontSize: \"12px\"\n          },\n          children: [/*#__PURE__*/_jsx(LockOutlined, {\n            style: {\n              margin: \"0 5px\",\n              color: \"#999\"\n            }\n          }), \"\\uBE44\\uBC00 \\uB313\\uAE00\"]\n        })]\n      }) : /*#__PURE__*/_jsxs(_Fragment, {\n        children: [/*#__PURE__*/_jsx(LockOutlined, {\n          style: {\n            margin: \"0 5px\",\n            color: \"#999\"\n          }\n        }), /*#__PURE__*/_jsx(\"span\", {\n          style: {\n            color: \"#999\"\n          },\n          children: \"\\uBE44\\uBC00 \\uB313\\uAE00\\uC785\\uB2C8\\uB2E4.\"\n        })]\n      }) : item.content : \"탈퇴한 회원입니다.\",\n      datetime: `${new Date(item.createdAt).getMonth() + 1}/${new Date(item.createdAt).getDate()}  ${new Date(item.createdAt).getHours()}:${new Date(item.createdAt).getMinutes() < 10 ? \"0\" + new Date(item.createdAt).getMinutes() : new Date(item.createdAt).getMinutes()}:${new Date(item.createdAt).getSeconds() < 10 ? \"0\" + new Date(item.createdAt).getSeconds() : new Date(item.createdAt).getSeconds()}`,\n      children: post.comments.map((reComment, i) => {\n        if (reComment.commentTo === item._id) {\n          return /*#__PURE__*/_jsx(ReCommentListItem, {\n            reComment: reComment,\n            post: post,\n            me: me,\n            onDeleteComment: onDeleteComment\n          }, reComment._id);\n        }\n      })\n    })\n  });\n};\n\nexport default CommentListItem;","map":null,"metadata":{},"sourceType":"module"}